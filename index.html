<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Para VocÃª</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒ‘</text></svg>">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #000;
    font-family: 'Cormorant Garamond', serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .video-layer {
    position: fixed;
    top: 50%; left: 50%;
    min-width: 100%; min-height: 100%;
    width: auto; height: auto;
    transform: translate(-50%, -50%);
    object-fit: cover;
    opacity: 0; z-index: 1;
    pointer-events: none;
    will-change: opacity;
    transition: opacity 4s ease;
  }
  .video-layer.active { opacity: 1; z-index: 2; }
  .video-layer.fading-out { opacity: 0; z-index: 1; }

  .infinity-layer {
    position: fixed;
    top: 50%; left: 50%;
    min-width: 100%; min-height: 100%;
    width: auto; height: auto;
    transform: translate(-50%, -50%);
    object-fit: cover;
    z-index: 0; opacity: 0;
    pointer-events: none;
    will-change: opacity;
    transition: opacity 3s ease;
  }
  .infinity-layer.active { opacity: 1; }

  #fade-to-black {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: #000; z-index: 3;
    opacity: 0; pointer-events: none;
  }

  .vignette {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; z-index: 10;
    background: radial-gradient(ellipse at center, transparent 35%, rgba(0,0,0,0.5) 100%);
  }

  .film-grain {
    position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
    pointer-events: none; z-index: 11; opacity: 0.025;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
    animation: grain 0.5s steps(1) infinite;
  }
  @keyframes grain {
    0%   { transform: translate(0,0); }
    20%  { transform: translate(-4%,-4%); }
    40%  { transform: translate(4%,4%); }
    60%  { transform: translate(-2%,3%); }
    80%  { transform: translate(3%,-2%); }
    100% { transform: translate(0,0); }
  }

  .letterbox { position: fixed; left: 0; width: 100%; background: #000; z-index: 12; pointer-events: none; }
  .letterbox.top { top: 0; height: 5.5vh; }
  .letterbox.bottom { bottom: 0; height: 5.5vh; }
  @media (max-width: 768px) { .letterbox.top { height: 3vh; } .letterbox.bottom { height: 3vh; } }

  #color-grade {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; z-index: 9;
    mix-blend-mode: soft-light; opacity: 0;
    transition: background 5s ease, opacity 5s ease;
  }

  #sky-backdrop {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; z-index: 19;
    background: radial-gradient(ellipse at center, rgba(0,0,0,0.35) 0%, transparent 70%);
    opacity: 0; transition: opacity 3s ease;
  }
  #sky-backdrop.active { opacity: 1; }

  #overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    display: flex; align-items: center; justify-content: center;
    pointer-events: none; z-index: 20;
  }

  .cinematic-text {
    color: #fff; font-weight: 300;
    font-size: clamp(1.15rem, 3.2vw, 2.15rem);
    text-align: center; max-width: 72vw;
    line-height: 1.9; letter-spacing: 0.1em;
    opacity: 0; transform: translateY(14px);
    transition: opacity 3s ease, transform 3.2s ease;
    text-shadow:
      0 0 15px rgba(0,0,0,1),
      0 0 40px rgba(0,0,0,0.95),
      0 0 80px rgba(0,0,0,0.85),
      0 0 120px rgba(0,0,0,0.6),
      0 2px 8px rgba(0,0,0,1);
    padding: 0 1.5rem;
  }
  .cinematic-text.visible { opacity: 1; transform: translateY(0); }
  @media (max-width: 768px) {
    .cinematic-text { max-width: 88vw; line-height: 2; letter-spacing: 0.06em; font-size: clamp(1.05rem, 4.8vw, 1.45rem); }
  }

  #start-screen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #000; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    z-index: 100; cursor: pointer; transition: opacity 3s ease;
  }
  #start-screen.hidden { opacity: 0; pointer-events: none; }
  #start-screen h1 { color: #fff; font-weight: 300; font-size: clamp(1.5rem, 4.5vw, 2.8rem); letter-spacing: 0.22em; margin-bottom: 2rem; text-transform: lowercase; }
  #start-screen .subtitle { color: rgba(255,255,255,0.4); font-weight: 300; font-style: italic; font-size: clamp(0.8rem, 2vw, 1rem); letter-spacing: 0.14em; margin-bottom: 3rem; }
  .play-btn { width: 62px; height: 62px; border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem; transition: all 0.5s ease; }
  .play-btn:hover { border-color: rgba(255,255,255,0.55); transform: scale(1.07); }
  .play-btn svg { width: 16px; height: 16px; fill: rgba(255,255,255,0.55); margin-left: 3px; }
  .play-hint { color: rgba(255,255,255,0.35); font-weight: 300; font-size: clamp(0.65rem, 1.5vw, 0.78rem); letter-spacing: 0.35em; text-transform: uppercase; animation: breathe 3s ease-in-out infinite; }
  @keyframes breathe { 0%,100% { opacity: 0.2; } 50% { opacity: 0.6; } }

  #progress-bar {
    position: fixed; bottom: 0; left: 0; height: 2px;
    background: linear-gradient(90deg, rgba(242,242,242,0.02), rgba(242,242,242,0.15));
    z-index: 25; width: 0%; transition: width 0.4s linear, opacity 2s ease;
  }

  #final-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    z-index: 30; opacity: 0; pointer-events: none;
    transition: opacity 4s ease;
  }
  #final-overlay.visible { opacity: 1; pointer-events: auto; }
  #final-overlay .heart {
    font-size: clamp(1.6rem, 3vw, 2.2rem);
    color: rgba(255,255,255,0.75); margin-bottom: 1rem;
    animation: heartbeat 2.5s ease-in-out infinite;
    text-shadow: 0 0 30px rgba(255,255,255,0.12);
  }
  @keyframes heartbeat { 0%,100% { transform: scale(1); } 15% { transform: scale(1.12); } 30% { transform: scale(1); } 45% { transform: scale(1.08); } 60% { transform: scale(1); } }
  #final-overlay .final-text {
    color: rgba(255,255,255,0.65); font-weight: 300; font-style: italic;
    font-size: clamp(0.9rem, 2.2vw, 1.15rem);
    letter-spacing: 0.12em; margin-bottom: 2.5rem;
    text-shadow: 0 0 20px rgba(0,0,0,0.5);
  }
  #replay-btn {
    color: rgba(255,255,255,0.25); font-family: 'Cormorant Garamond', serif;
    font-weight: 300; font-size: 0.72rem; letter-spacing: 0.3em; text-transform: lowercase;
    background: none; border: 1px solid rgba(255,255,255,0.12);
    padding: 0.5rem 1.5rem; cursor: pointer; border-radius: 2px;
    opacity: 0; pointer-events: none;
    transition: opacity 3s ease, border-color 0.4s ease, color 0.4s ease;
  }
  #replay-btn.visible { opacity: 1; pointer-events: auto; }
  #replay-btn:hover { color: rgba(255,255,255,0.55); border-color: rgba(255,255,255,0.3); }

  #mute-btn {
    position: fixed; bottom: 1.8rem; right: 1.8rem;
    z-index: 40; width: 36px; height: 36px;
    background: none; border: none; cursor: pointer;
    opacity: 0; pointer-events: none;
    transition: opacity 2s ease;
    display: flex; align-items: center; justify-content: center;
  }
  #mute-btn.visible { opacity: 1; pointer-events: auto; }
  #mute-btn svg { width: 18px; height: 18px; fill: rgba(255,255,255,0.25); transition: fill 0.3s ease; }
  #mute-btn:hover svg { fill: rgba(255,255,255,0.5); }

  #loading {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #000; z-index: 150;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    transition: opacity 1.5s ease;
  }
  #loading.hidden { opacity: 0; pointer-events: none; }
  #loading .load-text { color: rgba(242,242,242,0.35); font-weight: 300; font-size: 0.82rem; letter-spacing: 0.3em; text-transform: lowercase; margin-bottom: 1.5rem; }
  #loading .load-bar-bg { width: 100px; height: 1px; background: rgba(242,242,242,0.08); overflow: hidden; }
  #loading .load-bar { height: 100%; width: 0%; background: rgba(242,242,242,0.35); transition: width 0.3s ease; }
</style>
</head>
<body>

<div id="loading">
  <div class="load-text">preparando</div>
  <div class="load-bar-bg"><div class="load-bar" id="load-bar"></div></div>
</div>

<div id="start-screen" style="display:none;">
  <h1>para vocÃª</h1>
  <div class="subtitle">uma jornada</div>
  <div class="play-btn"><svg viewBox="0 0 24 24"><polygon points="8,5 19,12 8,19"/></svg></div>
  <div class="play-hint">toque para iniciar</div>
</div>

<video id="vid-forest" class="video-layer" muted playsinline preload="auto" src="forest.mp4"></video>
<video id="vid-ocean"  class="video-layer" muted playsinline preload="auto" loop src="ocean.mp4"></video>
<video id="vid-sky"    class="video-layer" muted playsinline preload="auto" loop src="sky.mp4"></video>
<video id="vid-space"  class="video-layer" muted playsinline preload="auto" src="space.mp4"></video>

<video id="inf-a" class="infinity-layer" muted playsinline preload="auto" src="infinity.mp4"></video>
<video id="inf-b" class="infinity-layer" muted playsinline preload="auto" src="infinity.mp4"></video>

<!-- Main music + ambient loop copy -->
<audio id="music-main" preload="auto" src="music.mp3"></audio>
<audio id="music-loop" preload="auto" src="music.mp3" loop></audio>

<div id="fade-to-black"></div>
<div class="vignette"></div>
<div class="film-grain"></div>
<div id="color-grade"></div>
<div id="sky-backdrop"></div>
<div class="letterbox top"></div>
<div class="letterbox bottom"></div>

<div id="overlay">
  <div id="cinematic-text" class="cinematic-text"></div>
</div>

<div id="final-overlay">
  <div class="heart">&#10084;</div>
  <div class="final-text">com amor, para sempre</div>
  <button id="replay-btn">assistir novamente</button>
</div>

<div id="progress-bar"></div>

<button id="mute-btn" title="Mutar/Desmutar">
  <svg id="icon-sound" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
  </svg>
  <svg id="icon-muted" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="display:none;">
    <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
  </svg>
</button>

<script>
(function() {
  'use strict';

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  CONFIG
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const PHASES = [
    { id:'forest', videoStart:0, videoEnd:10, textStart:1.5, textEnd:8.5,
      text:"Entre milhÃµes de caminhos possÃ­veisâ€¦\neu encontrei vocÃª.",
      grade:'linear-gradient(180deg,rgba(30,60,30,.25) 0%,transparent 50%,rgba(15,25,10,.2) 100%)', gradeOpacity:.12,
      volume: 0.35 },
    { id:'ocean', videoStart:7.5, videoEnd:23, textStart:12, textEnd:20.5,
      text:"VocÃª tem a profundidade de quem\nnÃ£o precisa provar nada.",
      grade:'linear-gradient(180deg,rgba(15,40,70,.3) 0%,transparent 50%,rgba(8,18,35,.2) 100%)', gradeOpacity:.15,
      volume: 0.55 },
    { id:'sky', videoStart:20.5, videoEnd:38, textStart:26, textEnd:35,
      text:"VocÃª tem o dom de clarear\nqualquer dia.",
      grade:'linear-gradient(180deg,rgba(50,70,90,.2) 0%,transparent 50%,rgba(35,45,60,.15) 100%)', gradeOpacity:.1,
      volume: 0.75 },
    { id:'space', videoStart:35.5, videoEnd:999, textStart:41, textEnd:52,
      text:"Entre tudo que poderia serâ€¦\nfoi vocÃª.",
      grade:'linear-gradient(180deg,rgba(8,8,25,.4) 0%,transparent 50%,rgba(4,4,12,.3) 100%)', gradeOpacity:.2,
      volume: 1.0 }
  ];

  const FADE_DELAY = 1.5;

  // Ambient loop: soft opening of the song
  const LOOP_START = 0;     // seconds
  const LOOP_END   = 25;    // seconds
  const LOOP_VOL   = 0.15;  // very quiet ambient

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  ELEMENTS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const vids = {
    forest: document.getElementById('vid-forest'),
    ocean:  document.getElementById('vid-ocean'),
    sky:    document.getElementById('vid-sky'),
    space:  document.getElementById('vid-space')
  };

  const infA = document.getElementById('inf-a');
  const infB = document.getElementById('inf-b');

  const musicMain    = document.getElementById('music-main');
  const musicLoop    = document.getElementById('music-loop');
  const loading      = document.getElementById('loading');
  const loadBar      = document.getElementById('load-bar');
  const startScreen  = document.getElementById('start-screen');
  const textEl       = document.getElementById('cinematic-text');
  const progressBar  = document.getElementById('progress-bar');
  const colorGrade   = document.getElementById('color-grade');
  const skyBackdrop  = document.getElementById('sky-backdrop');
  const fadeToBlack  = document.getElementById('fade-to-black');
  const finalOverlay = document.getElementById('final-overlay');
  const replayBtn    = document.getElementById('replay-btn');
  const muteBtn      = document.getElementById('mute-btn');
  const iconSound    = document.getElementById('icon-sound');
  const iconMuted    = document.getElementById('icon-muted');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  STATE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  let isPlaying = false, startTime = 0, currentText = '', currentPhaseId = '';
  let fadeStarted = false;
  let infRunning = false, infCurrent = 'a', infLoopTimer = null;
  let isMuted = false;
  let targetVolume = 0.35;
  let lastPhaseVolume = '';
  let mainMusicEnded = false;
  let ambientLoopStarted = false;
  let loopCheckTimer = null;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  AUDIO SYSTEM
  //
  //  Main music: plays full 1:46.
  //  Volume ramps per phase (forestâ†’space).
  //  After main ends: ambient loop fades in
  //  using the soft opening (0-25s) at 15%.
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function smoothVolume(audio, target, durationMs) {
    if (isMuted) return;
    const start = audio.volume;
    const diff = target - start;
    if (Math.abs(diff) < 0.01) { audio.volume = target; return; }
    const startT = performance.now();

    function step(now) {
      const elapsed = now - startT;
      const progress = Math.min(1, elapsed / durationMs);
      // Ease out
      const ease = 1 - Math.pow(1 - progress, 3);
      audio.volume = Math.max(0, Math.min(1, start + diff * ease));
      if (progress < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  function startMainMusic() {
    mainMusicEnded = false;
    ambientLoopStarted = false;
    musicMain.currentTime = 0;
    musicMain.volume = 0;
    musicMain.play().catch(() => console.warn('Audio blocked'));

    // Monitor main music ending â†’ transition to ambient loop
    musicMain.onended = function() {
      mainMusicEnded = true;
      startAmbientLoop();
    };
  }

  function startAmbientLoop() {
    if (ambientLoopStarted || isMuted) return;
    ambientLoopStarted = true;

    musicLoop.currentTime = LOOP_START;
    musicLoop.volume = 0;
    musicLoop.play().catch(() => {});

    // Fade in ambient
    smoothVolume(musicLoop, LOOP_VOL, 4000);

    // Keep looping within LOOP_START â†’ LOOP_END
    if (loopCheckTimer) clearInterval(loopCheckTimer);
    loopCheckTimer = setInterval(() => {
      if (!ambientLoopStarted) { clearInterval(loopCheckTimer); return; }
      if (musicLoop.currentTime >= LOOP_END - 2) {
        // Crossfade: fade out, seek back, fade in
        smoothVolume(musicLoop, 0, 2000);
        setTimeout(() => {
          musicLoop.currentTime = LOOP_START;
          if (!isMuted && ambientLoopStarted) {
            smoothVolume(musicLoop, LOOP_VOL, 3000);
          }
        }, 2200);
      }
    }, 500);
  }

  function stopAllAudio() {
    musicMain.pause();
    musicMain.currentTime = 0;
    musicMain.onended = null;
    musicLoop.pause();
    musicLoop.currentTime = 0;
    mainMusicEnded = false;
    ambientLoopStarted = false;
    if (loopCheckTimer) { clearInterval(loopCheckTimer); loopCheckTimer = null; }
  }

  // â”€â”€â”€ MUTE â”€â”€â”€
  muteBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    isMuted = !isMuted;
    if (isMuted) {
      musicMain.volume = 0;
      musicLoop.volume = 0;
      iconSound.style.display = 'none';
      iconMuted.style.display = 'block';
    } else {
      if (!mainMusicEnded) {
        musicMain.volume = targetVolume;
      }
      if (ambientLoopStarted) {
        musicLoop.volume = LOOP_VOL;
      }
      iconSound.style.display = 'block';
      iconMuted.style.display = 'none';
    }
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  INFINITY SEAMLESS LOOP
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function infStart() {
    if (infRunning) return;
    infRunning = true;
    infCurrent = 'a';
    infA.currentTime = 0;
    infA.play().catch(() => {});
    infA.classList.add('active');
    infB.classList.remove('active');
    infB.pause();
    infLoopTimer = setInterval(infCheckLoop, 200);
  }

  function infCheckLoop() {
    if (!infRunning) return;
    const current = infCurrent === 'a' ? infA : infB;
    const next    = infCurrent === 'a' ? infB : infA;
    if (current.duration && current.currentTime >= current.duration - 3) {
      if (next.classList.contains('active')) return;
      next.currentTime = 0;
      next.play().catch(() => {});
      next.classList.add('active');
      current.classList.remove('active');
      current.classList.add('fading-out');
      const oldId = infCurrent;
      infCurrent = infCurrent === 'a' ? 'b' : 'a';
      setTimeout(() => {
        const old = oldId === 'a' ? infA : infB;
        old.classList.remove('fading-out');
        old.pause(); old.currentTime = 0;
      }, 3500);
    }
  }

  function infStop() {
    infRunning = false;
    if (infLoopTimer) { clearInterval(infLoopTimer); infLoopTimer = null; }
    infA.pause(); infA.currentTime = 0; infA.classList.remove('active','fading-out');
    infB.pause(); infB.currentTime = 0; infB.classList.remove('active','fading-out');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  LOAD
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const loadKeys = ['forest','ocean','sky','space'];
  let loaded = 0;
  const totalToLoad = 6;

  function onReady() {
    loaded++;
    loadBar.style.width = (loaded / totalToLoad * 100) + '%';
    if (loaded >= totalToLoad) {
      setTimeout(() => {
        loading.classList.add('hidden');
        setTimeout(() => { startScreen.style.display = 'flex'; }, 400);
      }, 600);
    }
  }

  loadKeys.forEach(key => {
    const v = vids[key];
    v.addEventListener('canplaythrough', function h() { v.removeEventListener('canplaythrough',h); onReady(); });
    v.addEventListener('error', function h() { v.removeEventListener('error',h); onReady(); });
    setTimeout(() => { if (loaded < totalToLoad) onReady(); }, 15000);
    v.load();
  });

  infA.addEventListener('canplaythrough', function h() { infA.removeEventListener('canplaythrough',h); onReady(); });
  infA.addEventListener('error', function h() { infA.removeEventListener('error',h); onReady(); });
  setTimeout(() => { if (loaded < totalToLoad) onReady(); }, 15000);
  infA.load(); infB.load();

  musicMain.addEventListener('canplaythrough', function h() { musicMain.removeEventListener('canplaythrough',h); onReady(); });
  musicMain.addEventListener('error', function h() { musicMain.removeEventListener('error',h); onReady(); });
  setTimeout(() => { if (loaded < totalToLoad) onReady(); }, 15000);
  musicMain.load(); musicLoop.load();

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  MAIN ENGINE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function tick(now) {
    if (!isPlaying) return;
    requestAnimationFrame(tick);

    const time = (now - startTime) / 1000;

    if (!fadeStarted) {
      let active = PHASES[0];
      for (let i = PHASES.length - 1; i >= 0; i--) {
        if (time >= PHASES[i].videoStart) { active = PHASES[i]; break; }
      }

      if (active.id !== currentPhaseId) {
        if (currentPhaseId && vids[currentPhaseId]) {
          const prev = vids[currentPhaseId];
          prev.classList.remove('active');
          prev.classList.add('fading-out');
          const old = currentPhaseId;
          setTimeout(() => {
            if (vids[old]) { vids[old].classList.remove('fading-out'); if (old !== 'space') vids[old].pause(); }
          }, 4500);
        }
        const next = vids[active.id];
        next.currentTime = 0;
        next.play().catch(() => {});
        next.classList.remove('fading-out');
        next.classList.add('active');
        colorGrade.style.background = active.grade;
        colorGrade.style.opacity = active.gradeOpacity;
        currentPhaseId = active.id;
      }

      // Music volume ramp per phase
      if (active.id !== lastPhaseVolume && !mainMusicEnded) {
        targetVolume = active.volume;
        smoothVolume(musicMain, active.volume, 3000);
        lastPhaseVolume = active.id;
      }

      if (active.id === 'sky' && time >= PHASES[2].textStart - 1 && time <= PHASES[2].textEnd + 1) {
        skyBackdrop.classList.add('active');
      } else {
        skyBackdrop.classList.remove('active');
      }

      const totalEst = PHASES[3].textEnd + FADE_DELAY + 3;
      progressBar.style.width = Math.min(100, (time / totalEst * 100)) + '%';
    }

    // Text
    let newText = '';
    for (const p of PHASES) {
      if (time >= p.textStart && time <= p.textEnd) { newText = p.text; break; }
    }
    if (newText !== currentText) {
      if (newText === '') { textEl.classList.remove('visible'); }
      else {
        textEl.innerHTML = newText.replace(/\n/g,'<br>');
        textEl.classList.remove('visible');
        requestAnimationFrame(() => { requestAnimationFrame(() => { textEl.classList.add('visible'); }); });
      }
      currentText = newText;
    }

    // Fade trigger
    const fadeTime = PHASES[3].textEnd + FADE_DELAY;
    if (time >= fadeTime && !fadeStarted) {
      fadeStarted = true;
      isPlaying = false;
      textEl.classList.remove('visible');
      currentText = '';
      skyBackdrop.classList.remove('active');

      // Music: let it keep playing naturally â€” no cut!
      // It will continue through the fade and infinity reveal.
      // When it ends (~1:46), onended triggers the ambient loop.

      infStart();

      fadeToBlack.style.transition = 'opacity 3s ease';
      fadeToBlack.style.opacity = '1';
      progressBar.style.width = '100%';

      setTimeout(() => {
        loadKeys.forEach(k => {
          vids[k].classList.remove('active','fading-out');
          vids[k].pause(); vids[k].currentTime = 0;
        });
        colorGrade.style.opacity = '0';
        fadeToBlack.style.transition = 'opacity 4s ease';
        fadeToBlack.style.opacity = '0';
        progressBar.style.opacity = '0';
      }, 3500);

      setTimeout(() => { finalOverlay.classList.add('visible'); }, 6000);
      setTimeout(() => { replayBtn.classList.add('visible'); }, 8000);
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  START
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function beginExperience() {
    startScreen.classList.add('hidden');

    // Unlock & start audio on user gesture
    startMainMusic();

    setTimeout(() => {
      isPlaying = true;
      fadeStarted = false;
      startTime = performance.now();
      currentPhaseId = '';
      currentText = '';
      lastPhaseVolume = '';
      muteBtn.classList.add('visible');
      requestAnimationFrame(tick);
    }, 900);
  }

  startScreen.addEventListener('click', beginExperience);
  startScreen.addEventListener('touchend', e => { e.preventDefault(); beginExperience(); });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  REPLAY
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  replayBtn.addEventListener('click', () => {
    infStop();
    stopAllAudio();

    fadeToBlack.style.transition = 'opacity 1.5s ease';
    fadeToBlack.style.opacity = '1';

    finalOverlay.style.transition = 'opacity 0.8s ease';
    finalOverlay.classList.remove('visible');
    replayBtn.classList.remove('visible');

    setTimeout(() => {
      finalOverlay.style.transition = 'opacity 4s ease';
      textEl.classList.remove('visible');
      progressBar.style.width = '0%';
      progressBar.style.opacity = '1';
      colorGrade.style.opacity = '0';
      skyBackdrop.classList.remove('active');
      currentText = '';
      currentPhaseId = '';
      lastPhaseVolume = '';
      fadeStarted = false;

      fadeToBlack.style.transition = 'none';
      fadeToBlack.style.opacity = '0';

      loadKeys.forEach(k => {
        vids[k].classList.remove('active','fading-out');
        vids[k].pause(); vids[k].currentTime = 0;
      });

      // Restart music
      startMainMusic();
      muteBtn.classList.add('visible');

      setTimeout(() => {
        fadeToBlack.style.transition = 'opacity 2s ease';
        fadeToBlack.style.opacity = '0';
        isPlaying = true;
        startTime = performance.now();
        requestAnimationFrame(tick);
      }, 500);
    }, 1800);
  });

})();
</script>
</body>
</html>